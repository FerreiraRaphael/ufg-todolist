language: node_js

node_js:
  - 7.4.0

env:
 global:
  - WEBAPP_DIR=$SHIPPABLE_REPO_DIR/webapp
  - TEST_RESULTS_DIR=$SHIPPABLE_REPO_DIR/shippable/testresults
  - CODE_COVERAGE_DIR=$SHIPPABLE_REPO_DIR/shippable/codecoverage
  - NODE_ENV=development
  - PORT=4040
  - JWT_SECRET=0a6b944d-d2fb-46fc-a85e-0295c986cd9f
  - MONGO_HOST=mongodb://ufg:ufg123456@ds111895.mlab.com:11895/ufg-todolist
  - MONGO_PORT=11895
  - API_TEST_RESULTS=$SHIPPABLE_REPO_DIR/test-results.xml
  - API_COVERAGE_RESULTS=$SHIPPABLE_REPO_DIR/coverage/clover.xml
  - WEBAPP_TEST_RESULTS=$WEBAPP_DIR/junit.xml
  - WEBAPP_COVERAGE_RESULT=$WEBAPP_DIR/coverage/clover.xml
  - API_MOD_LOC=$SHIPPABLE_REPO_DIR/node_modules/.bin
  - WEBAPP_MOD_LOC=$WEBAPP_DIR/node_modules/.bin

build:
  ci:
    # Install dependencies
    - shippable_retry yarn && cd webapp && shippable_retry yarn
    # Test Webapp
    - $WEBAPP_MOD_LOC/react-scripts test --env=jsdom --testResultsProcessor jest-junit --coverage
    #- yarn test:coverage:ci
    - ls && cd .. && ls && cd webapp
    - mv $WEBAPP_TEST_RESULTS $TEST_RESULTS_DIR/webapp-testresults.xml
    - mv $WEBAPP_COVERAGE_RESULT $CODE_COVERAGE_DIR/webapp-coverageresult.xml
    # Test Api
    - cd ..
    - yarn test:ci
    - $API_MOD_LOC/cross-env NODE_ENV=test $API_MOD_LOC/istanbul --include-all-sources cover -root "$SHIPPABLE_REPO_DIR/server" ./node_modules/mocha/bin/_mocha -- --compilers js:babel-core/register -R  spec-xunit-file --recursive "$SHIPPABLE_REPO_DIR/server/tests/"
    - $API_MOD_LOC/istanbul report
    - mv $API_TEST_RESULTS $TEST_RESULTS_DIR/api-testresults.xml
